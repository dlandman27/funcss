<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A terminal emulator that uses localStorage as a virtual filesystem">
    <meta name="keywords" content="terminal, localStorage, javascript, web terminal, virtual filesystem">
    <meta name="author" content="LocalStorage Terminal">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="LocalStorage Terminal">
    <meta property="og:description" content="A terminal emulator that uses localStorage as a virtual filesystem">
    <meta property="og:type" content="website">
    <meta property="og:image" content="terminal-preview.png">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300ff00'><path d='M8 18h8v-2H8v2zm0-4h8v-2H8v2zm0-4h8V8H8v2zm-2 8V6c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2z'/></svg>">
    
    <title>LocalStorage Terminal</title>
    <style>
        body {
            background: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            margin: 0;
            padding: 20px;
        }

        #terminal {
            width: 100%;
            height: calc(100vh - 100px);
            overflow-y: auto;
            background: #000;
            padding: 20px;
            border-radius: 5px;
            box-sizing: border-box;
            position: relative;
        }

        #input-line {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        #prompt {
            color: #00ff00;
            margin-right: 10px;
        }

        #command-input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: monospace;
            font-size: 16px;
            flex-grow: 1;
            outline: none;
            /* Disable browser autocomplete */
            autocomplete: off;
            autocorrect: off;
            autocapitalize: off;
            spellcheck: false;
        }

        .output-line {
            margin: 5px 0;
            white-space: pre-wrap;
        }

        .error {
            color: #ff0000;
        }

        #editor {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: #1e1e1e;
            border: 1px solid #00ff00;
            padding: 20px;
            z-index: 100;
        }

        #editor-content {
            width: 100%;
            height: calc(100% - 40px);
            background: #000;
            color: #00ff00;
            border: none;
            font-family: monospace;
            padding: 10px;
            resize: none;
            outline: none;
        }

        #editor-status {
            height: 30px;
            padding: 5px;
            color: #00ff00;
            font-family: monospace;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div id="terminal">
        <div class="output-line">Welcome to LocalStorage Terminal v1.0</div>
        <div class="output-line">Type 'help' for available commands</div>
        <div id="output"></div>
        <div id="input-line">
            <span id="prompt">user@localhost:~$</span>
            <input type="text" id="command-input" autofocus autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
        <div id="editor">
            <textarea id="editor-content"></textarea>
            <div id="editor-status">
                <span id="editor-file"></span>
                <span>Ctrl+S to save, Esc to exit</span>
            </div>
        </div>
    </div>
    <input type="file" id="file-input" accept=".json">

    <script>
        const terminal = document.getElementById('terminal');
        const output = document.getElementById('output');
        const input = document.getElementById('command-input');
        const editor = document.getElementById('editor');
        const editorContent = document.getElementById('editor-content');
        const editorFile = document.getElementById('editor-file');
        const fileInput = document.getElementById('file-input');
        let currentDir = '/';
        const MAX_STORAGE = 5 * 1024 * 1024; // 5MB limit
        let commandHistory = [];
        let historyIndex = -1;
        let lastCommand;
        let currentEditingFile = null;

        // Editor event handlers
        editorContent.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveCurrentFile();
                closeEditor(); // Add this line to close editor after saving
            } else if (e.key === 'Escape') {
                closeEditor();
            } else if (e.key === 'Tab') {
                e.preventDefault();
                const start = editorContent.selectionStart;
                const end = editorContent.selectionEnd;
                editorContent.value = editorContent.value.substring(0, start) + '\t' + editorContent.value.substring(end);
                editorContent.selectionStart = editorContent.selectionEnd = start + 1;
            }
        });

        function saveCurrentFile() {
            if (!currentEditingFile) return;
            
            const path = getPath(currentEditingFile);
            const parentPath = path.substring(0, path.lastIndexOf('/'));
            const name = path.substring(path.lastIndexOf('/') + 1);
            
            const parentDir = getDirectoryFromPath(parentPath);
            if (!parentDir) return;
            
            parentDir.contents[name] = {
                type: 'file',
                content: editorContent.value
            };
            saveFS();
            printLine(`Saved ${currentEditingFile}`);
        }

        function closeEditor() {
            editor.style.display = 'none';
            currentEditingFile = null;
            input.focus();
        }

        function openEditor(filename) {
            const path = getPath(filename);
            const parentPath = path.substring(0, path.lastIndexOf('/'));
            const name = path.substring(path.lastIndexOf('/') + 1);
            
            const parentDir = getDirectoryFromPath(parentPath);
            if (!parentDir) return printLine('Invalid path', 'error');
            
            const file = parentDir.contents[name];
            if (!file) {
                parentDir.contents[name] = {
                    type: 'file',
                    content: ''
                };
                saveFS();
            }
            
            currentEditingFile = filename;
            editorContent.value = file ? file.content : '';
            editorFile.textContent = filename;
            editor.style.display = 'block';
            editorContent.focus();
        }

        // Always focus input on click anywhere
        document.addEventListener('click', (e) => {
            if (!editor.contains(e.target)) {
                input.focus();
            }
        });

        // Focus input when any key is pressed
        document.addEventListener('keydown', (e) => {
            if (editor.style.display === 'block') return;
            
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    input.value = commandHistory[commandHistory.length - 1 - historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    input.value = commandHistory[commandHistory.length - 1 - historyIndex];
                } else if (historyIndex === 0) {
                    historyIndex = -1;
                    input.value = '';
                }
            } else {
                input.focus();
            }
        });

        const fileSystem = {
            '/': {
                type: 'directory',
                contents: {}
            }
        };

        // Load existing data from localStorage
        try {
            const savedFS = localStorage.getItem('fileSystem');
            if (savedFS) {
                Object.assign(fileSystem, JSON.parse(savedFS));
            }
        } catch (e) {
            console.error('Error loading filesystem:', e);
        }

        function saveFS() {
            try {
                localStorage.setItem('fileSystem', JSON.stringify(fileSystem));
            } catch (e) {
                printLine('Error: Storage quota exceeded!', 'error');
            }
        }

        function printLine(text, className = '') {
            const line = document.createElement('div');
            line.className = `output-line ${className}`;
            line.textContent = text;
            output.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function normalizePath(path) {
            // Handle . and ..
            const parts = path.split('/').filter(p => p);
            const stack = [];
            
            for (const part of parts) {
                if (part === '.') continue;
                if (part === '..') {
                    if (stack.length) stack.pop();
                    continue;
                }
                stack.push(part);
            }
            
            return '/' + stack.join('/');
        }

        function getPath(path) {
            if (path.startsWith('/')) return normalizePath(path);
            return normalizePath(currentDir + '/' + path);
        }

        function getDirectoryFromPath(path) {
            path = normalizePath(path);
            if (path === '/') return fileSystem['/'];
            
            let current = fileSystem['/'];
            const parts = path.split('/').filter(p => p);
            
            for (const part of parts) {
                if (!current.contents[part] || current.contents[part].type !== 'directory') {
                    return null;
                }
                current = current.contents[part];
            }
            return current;
        }

        const commands = {
            help: () => {
                printLine('Available commands:');
                printLine('  ls - List directory contents');
                printLine('  cd <dir> - Change directory (use .. to go up, . for current)');
                printLine('  mkdir <name> - Create directory');
                printLine('  touch <name> - Create file');
                printLine('  rm <name> - Remove file or directory');
                printLine('  sudo rm <name> - Force remove directory and contents');
                printLine('  cat <file> - Display file contents');
                printLine('  echo "<text>" > <file> - Write text to file');
                printLine('  edit <file> - Open text editor');
                printLine('  pwd - Print working directory');
                printLine('  clear/cls - Clear terminal');
                printLine('  df - Show storage usage');
                printLine('  !! - Repeat last command');
                printLine('  ifconfig/ipconfig - Show network information');
                printLine('  date - Show current date and time');
                printLine('  whoami - Show current user');
                printLine('  hostname - Show system hostname');
                printLine('  uname - Show system information');
                printLine('  export - Export filesystem to downloadable file');
                printLine('  import - Import filesystem from file');
            },

            ls: () => {
                const dir = getDirectoryFromPath(currentDir);
                if (!dir) return printLine('Directory not found', 'error');
                
                if (currentDir !== '/') {
                    printLine('d ..');
                }
                printLine('d .');
                
                Object.entries(dir.contents).forEach(([name, item]) => {
                    const prefix = item.type === 'directory' ? 'd ' : '- ';
                    printLine(prefix + name);
                });
            },

            cd: (args) => {
                if (!args[0]) {
                    currentDir = '/';
                    return;
                }

                const newPath = getPath(args[0]);
                const dir = getDirectoryFromPath(newPath);
                
                if (!dir) {
                    printLine('Directory not found', 'error');
                    return;
                }
                currentDir = newPath;
            },

            mkdir: (args) => {
                if (!args[0]) return printLine('Please specify directory name', 'error');
                
                const path = getPath(args[0]);
                const parentPath = path.substring(0, path.lastIndexOf('/'));
                const name = path.substring(path.lastIndexOf('/') + 1);
                
                const parentDir = getDirectoryFromPath(parentPath);
                if (!parentDir) return printLine('Invalid path', 'error');
                
                parentDir.contents[name] = {
                    type: 'directory',
                    contents: {}
                };
                saveFS();
            },

            touch: (args) => {
                if (!args[0]) return printLine('Please specify file name', 'error');
                
                const path = getPath(args[0]);
                const parentPath = path.substring(0, path.lastIndexOf('/'));
                const name = path.substring(path.lastIndexOf('/') + 1);
                
                const parentDir = getDirectoryFromPath(parentPath);
                if (!parentDir) return printLine('Invalid path', 'error');
                
                parentDir.contents[name] = {
                    type: 'file',
                    content: ''
                };
                saveFS();
            },

            edit: (args) => {
                if (!args[0]) return printLine('Please specify file name', 'error');
                openEditor(args[0]);
            },

            rm: (args) => {
                if (!args[0]) return printLine('Please specify name', 'error');
                
                const path = getPath(args[0]);
                const parentPath = path.substring(0, path.lastIndexOf('/'));
                const name = path.substring(path.lastIndexOf('/') + 1);
                
                const parentDir = getDirectoryFromPath(parentPath);
                if (!parentDir) return printLine('Invalid path', 'error');
                
                if (parentDir.contents[name]) {
                    // Check if trying to delete a non-empty directory
                    if (parentDir.contents[name].type === 'directory' && 
                        Object.keys(parentDir.contents[name].contents).length > 0) {
                        printLine('Cannot remove directory: Directory not empty', 'error');
                        return;
                    }
                    delete parentDir.contents[name];
                    saveFS();
                } else {
                    printLine('File or directory not found', 'error');
                }
            },

            sudo: (args) => {
                if (args[0] === '!!') {
                    if (!lastCommand) {
                        printLine('No previous command to execute', 'error');
                        return;
                    }
                    const [lastCmd, ...lastArgs] = lastCommand.split(' ');
                    if (lastCmd === 'sudo') {
                        commands.sudo(lastArgs);
                    } else {
                        commands.sudo([lastCmd, ...lastArgs]);
                    }
                    return;
                }

                if (args[0] === 'rm') {
                    if (!args[1]) return printLine('Please specify name', 'error');
                    
                    const path = getPath(args[1]);
                    const parentPath = path.substring(0, path.lastIndexOf('/'));
                    const name = path.substring(path.lastIndexOf('/') + 1);
                    
                    const parentDir = getDirectoryFromPath(parentPath);
                    if (!parentDir) return printLine('Invalid path', 'error');
                    
                    if (parentDir.contents[name]) {
                        delete parentDir.contents[name];
                        saveFS();
                    } else {
                        printLine('File or directory not found', 'error');
                    }
                } else {
                    printLine('Unknown sudo command', 'error');
                }
            },

            cat: (args) => {
                if (!args[0]) return printLine('Please specify file name', 'error');
                
                const path = getPath(args[0]);
                const parentPath = path.substring(0, path.lastIndexOf('/'));
                const name = path.substring(path.lastIndexOf('/') + 1);
                
                const parentDir = getDirectoryFromPath(parentPath);
                if (!parentDir) return printLine('Invalid path', 'error');
                
                const file = parentDir.contents[name];
                if (!file || file.type !== 'file') {
                    printLine('File not found', 'error');
                    return;
                }
                
                printLine(file.content);
            },

            echo: (args) => {
                // Join all args except the last 2 (> and filename) to handle spaces in text
                if (args.length < 3) {
                    printLine('Usage: echo "text" > file', 'error');
                    return;
                }

                const redirectIndex = args.indexOf('>');
                if (redirectIndex === -1 || redirectIndex === args.length - 1) {
                    printLine('Usage: echo "text" > file', 'error');
                    return;
                }

                const text = args.slice(0, redirectIndex).join(' ').replace(/^"/, '').replace(/"$/, '');
                const filename = args[redirectIndex + 1];
                
                const path = getPath(filename);
                const parentPath = path.substring(0, path.lastIndexOf('/'));
                const name = path.substring(path.lastIndexOf('/') + 1);
                
                const parentDir = getDirectoryFromPath(parentPath);
                if (!parentDir) return printLine('Invalid path', 'error');
                
                parentDir.contents[name] = {
                    type: 'file',
                    content: text
                };
                saveFS();
            },

            pwd: () => {
                printLine(currentDir);
            },

            clear: () => {
                output.innerHTML = '';
            },

            cls: () => {
                output.innerHTML = '';
            },

            df: () => {
                const used = new TextEncoder().encode(JSON.stringify(fileSystem)).length;
                const available = MAX_STORAGE - used;
                printLine(`Storage usage:`);
                printLine(`Total: ${MAX_STORAGE} bytes`);
                printLine(`Used: ${used} bytes`);
                printLine(`Available: ${available} bytes`);
            },

            ifconfig: () => {
                printLine('eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500');
                printLine('        inet 192.168.1.100  netmask 255.255.255.0  broadcast 192.168.1.255');
                printLine('        inet6 fe80::1234:5678:9abc:def0  prefixlen 64  scopeid 0x20<link>');
                printLine('        ether 00:11:22:33:44:55  txqueuelen 1000  (Ethernet)');
            },

            ipconfig: () => {
                commands.ifconfig();
            },

            date: () => {
                printLine(new Date().toString());
            },

            whoami: () => {
                printLine('user');
            },

            hostname: () => {
                printLine('localhost');
            },

            uname: () => {
                printLine('WebOS 1.0 LocalStorage Terminal x86_64');
            },

            export: () => {
                const data = JSON.stringify(fileSystem, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'filesystem.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                printLine('Filesystem exported successfully');
            },

            import: () => {
                fileInput.click();
            }
        };

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedFS = JSON.parse(event.target.result);
                    
                    // Validate the structure
                    if (!importedFS['/'] || importedFS['/'].type !== 'directory' || !importedFS['/'].contents) {
                        throw new Error('Invalid filesystem structure');
                    }
                    
                    Object.assign(fileSystem, importedFS);
                    saveFS();
                    printLine('Filesystem imported successfully');
                } catch (error) {
                    printLine('Error importing filesystem: Invalid format', 'error');
                }
            };
            reader.readAsText(file);
            fileInput.value = ''; // Reset file input
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const cmdLine = input.value.trim();
                printLine(document.getElementById('prompt').textContent + ' ' + cmdLine);
                
                let [cmd, ...args] = cmdLine.split(' ');

                if (cmd === '!!') {
                    if (!lastCommand) {
                        printLine('No previous command to execute', 'error');
                        input.value = '';
                        return;
                    }
                    [cmd, ...args] = lastCommand.split(' ');
                } else {
                    if (cmd && cmd !== '!!') {
                        lastCommand = cmdLine;
                        commandHistory.push(cmdLine);
                    }
                }
                
                if (commands[cmd]) {
                    commands[cmd](args);
                } else if (cmd) {
                    printLine(`Command not found: ${cmd}`, 'error');
                }
                
                historyIndex = -1;
                input.value = '';
            }
        });
    </script>
</body>
</html>
